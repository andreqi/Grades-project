function getOffsetRect(a){var b=a.getBoundingClientRect(),c=document.body,d=document.documentElement,e=window.pageYOffset||d.scrollTop||c.scrollTop,f=window.pageXOffset||d.scrollLeft||c.scrollLeft,g=d.clientTop||c.clientTop||0,h=d.clientLeft||c.clientLeft||0,i=b.top+e-g,j=b.left+f-h;return{top:Math.round(i),left:Math.round(j)}}function tree(a,b,c){var d=1e3,e=600,f={cx:d/2,cy:20,w:70,h:70},g={width:48,height:36,rx:5,ry:5,getX:function(a){return(2*a-this.width)/2},getY:function(a){return(2*a-this.height)/2}},h=0;f.vis={v:0,l:"J",p:{x:f.cx,y:f.cy},grade:-1,c:[],childLen:0,f:{},level:1};var i={};return i[h]=f.vis,h++,f.size=1,f.glabels=[],f.incMatx=[],f.incX=500,f.incY=30,f.incS=20,f.getVertices=function(){function a(c){b.push(c),c.c.forEach(a)}var b=[];return a(f.vis),b},f.getEdges=function(){function a(c){c.c.forEach(function(a){b.push({v1:c.v,l1:c.l,p1:c.p,v2:a.v,l2:a.l,p2:a.p})}),c.c.forEach(a)}var b=[];return a(f.vis),b},f.addLeaf=function(a){i[a].level>2||(i[h]={v:h,l:"J",grade:-1,p:{},c:[],childLen:0,f:i[a],level:i[a].level+1},i[a].childLen++,i[a].c.push(i[h]),h++,f.size++,reposition(f.vis),redraw())},f.removeLeaf=function(a){if(i[a]!=f.vis){var b=i[a].f;if(b){b.childLen--;for(var c=0;c<b.c.length;c++){var d=b.c[c];if(d===i[a]){delete b.c[c];break}}}reposition(f.vis),delete i[a],redraw()}},bindTextArea=function(a,b){var c=document.createElement("textarea"),d=getOffsetRect(a),e=c.style;e.resize="none",e.position="absolute",e.background="none",e.left=d.left+"px",e.top=d.top+"px",e.width=a.width+"px",e.height=a.hegth+"px",e.outline="none",e.overflow="hidden",e.border="0 none #FFF",e["-webkit-transform-origin"]="center center",c.textContent=a.textContent;var f=function(){b.l=c.value.trim(),b.l||(b.l="node"),a.textContent=b.l,$(c).remove(),a.style.display=""};$(c).focusout(f),$(c).keyup(function(a){13==a.which&&f()}),a.style.display="none",document.body.appendChild(c),c.focus()},f.simulate=function(){},redraw=function(){var a=d3.select("#g_lines").selectAll("line").data(f.getEdges(),function(a){return a.v2});a.transition().duration(500).attr("x1",function(a){return a.p1.x}).attr("y1",function(a){return a.p1.y}).attr("x2",function(a){return a.p2.x}).attr("y2",function(a){return a.p2.y}),a.enter().append("line").attr("x1",function(a){return a.p1.x}).attr("y1",function(a){return a.p1.y}).attr("x2",function(a){return a.p1.x}).attr("y2",function(a){return a.p1.y}).transition().duration(500).attr("x2",function(a){return a.p2.x}).attr("y2",function(a){return a.p2.y}),a.exit().remove();var b=d3.select("#g_nodes").selectAll("rect").data(f.getVertices(),function(a){return a.v});b.transition().duration(500).attr("x",function(a){return g.getX(a.p.x)}).attr("y",function(a){return g.getY(a.p.y)}),b.enter().append("rect").attr("x",function(a){return g.getX(a.f.p.x)}).attr("y",function(a){return g.getY(a.f.p.y)}).attr("width",g.width).attr("height",g.height).attr("rx",g.rx).attr("ry",g.ry).on("click",function(a){c(a)}).transition().duration(500).attr("x",function(a){return g.getX(a.p.x)}).attr("y",function(a){return g.getY(a.p.y)}),b.exit().remove();var d=d3.select("#g_labels").selectAll("text").data(f.getVertices(),function(a){return a.v});d.text(function(a){return a.l+"/"+a.grade}).transition().duration(500).attr("x",function(a){return a.p.x}).attr("y",function(a){return a.p.y+5}).attr("class",function(a){return 0==a.childLen?"leaf":""}),d.enter().append("text").attr("x",function(a){return a.f.p.x}).attr("y",function(a){return a.f.p.y+5}).attr("class",function(a){return 0==a.childLen?"leaf":""}).text(function(a){return a.l+"/"+a.grade}).on("click",function(a){c(a)}).transition().duration(500).attr("x",function(a){return a.p.x}).attr("y",function(a){return a.p.y+5}),d.exit().remove()},getLeafCount=function(a){return 0==a.childLen?1:a.c.map(getLeafCount).reduce(function(a,b){return a+b})},reposition=function(a){var b=getLeafCount(a),c=a.p.x-f.w*(b-1)/2;a.c.forEach(function(b){var d=f.w*getLeafCount(b);c+=d,b.p={x:c-(d+f.w)/2,y:a.p.y+f.h},reposition(b)})},initialize=function(a){d=$(a).width(),e=$(a).height(),d3.select(a).append("svg").attr("width",d).attr("height",e).attr("id","treesvg"),d3.select("#treesvg").append("g").attr("id","g_lines").selectAll("line").data(f.getEdges()).enter().append("line").attr("x1",function(a){return a.p1.x}).attr("y1",function(a){return a.p1.y}).attr("x2",function(a){return a.p2.x}).attr("y2",function(a){return a.p2.y}),d3.select("#treesvg").append("g").attr("id","g_nodes").selectAll("rect").data(f.getVertices()).enter().append("rect").attr("x",function(a){return g.getX(a.p.x)}).attr("y",function(a){return g.getY(a.p.y)}).attr("width",g.width).attr("height",g.height).attr("rx",g.rx).attr("ry",g.ry).on("click",function(a){c(a)}),d3.select("#treesvg").append("g").attr("id","g_labels").selectAll("text").data(f.getVertices()).enter().append("text").attr("x",function(a){return a.p.x}).attr("y",function(a){return a.p.y+5}).text(function(a){return a.l}).on("click",function(a){c(a)})},initialize(a,b),f.redraw=redraw,f}!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define(b):a.Spinner=b()}(this,function(){"use strict";function a(a,b){var c,d=document.createElement(a||"div");for(c in b)d[c]=b[c];return d}function b(a){for(var b=1,c=arguments.length;c>b;b++)a.appendChild(arguments[b]);return a}function c(a,b,c,d){var e=["opacity",b,~~(100*a),c,d].join("-"),f=.01+c/d*100,g=Math.max(1-(1-a)/b*(100-f),a),h=j.substring(0,j.indexOf("Animation")).toLowerCase(),i=h&&"-"+h+"-"||"";return l[e]||(m.insertRule("@"+i+"keyframes "+e+"{0%{opacity:"+g+"}"+f+"%{opacity:"+a+"}"+(f+.01)+"%{opacity:1}"+(f+b)%100+"%{opacity:"+a+"}100%{opacity:"+g+"}}",m.cssRules.length),l[e]=1),e}function d(a,b){var c,d,e=a.style;for(b=b.charAt(0).toUpperCase()+b.slice(1),d=0;d<k.length;d++)if(c=k[d]+b,void 0!==e[c])return c;return void 0!==e[b]?b:void 0}function e(a,b){for(var c in b)a.style[d(a,c)||c]=b[c];return a}function f(a){for(var b=1;b<arguments.length;b++){var c=arguments[b];for(var d in c)void 0===a[d]&&(a[d]=c[d])}return a}function g(a,b){return"string"==typeof a?a:a[b%a.length]}function h(a){this.opts=f(a||{},h.defaults,n)}function i(){function c(b,c){return a("<"+b+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',c)}m.addRule(".spin-vml","behavior:url(#default#VML)"),h.prototype.lines=function(a,d){function f(){return e(c("group",{coordsize:k+" "+k,coordorigin:-j+" "+-j}),{width:k,height:k})}function h(a,h,i){b(m,b(e(f(),{rotation:360/d.lines*a+"deg",left:~~h}),b(e(c("roundrect",{arcsize:d.corners}),{width:j,height:d.width,left:d.radius,top:-d.width>>1,filter:i}),c("fill",{color:g(d.color,a),opacity:d.opacity}),c("stroke",{opacity:0}))))}var i,j=d.length+d.width,k=2*j,l=2*-(d.width+d.length)+"px",m=e(f(),{position:"absolute",top:l,left:l});if(d.shadow)for(i=1;i<=d.lines;i++)h(i,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(i=1;i<=d.lines;i++)h(i);return b(a,m)},h.prototype.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&b+d<e.childNodes.length&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}}var j,k=["webkit","Moz","ms","O"],l={},m=function(){var c=a("style",{type:"text/css"});return b(document.getElementsByTagName("head")[0],c),c.sheet||c.styleSheet}(),n={lines:12,length:7,width:5,radius:10,rotate:0,corners:1,color:"#000",direction:1,speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"50%",left:"50%",position:"absolute"};h.defaults={},f(h.prototype,{spin:function(b){this.stop();var c=this,d=c.opts,f=c.el=e(a(0,{className:d.className}),{position:d.position,width:0,zIndex:d.zIndex});if(d.radius+d.length+d.width,e(f,{left:d.left,top:d.top}),b&&b.insertBefore(f,b.firstChild||null),f.setAttribute("role","progressbar"),c.lines(f,c.opts),!j){var g,h=0,i=(d.lines-1)*(1-d.direction)/2,k=d.fps,l=k/d.speed,m=(1-d.opacity)/(l*d.trail/100),n=l/d.lines;!function o(){h++;for(var a=0;a<d.lines;a++)g=Math.max(1-(h+(d.lines-a)*n)%l*m,d.opacity),c.opacity(f,a*d.direction+i,g,d);c.timeout=c.el&&setTimeout(o,~~(1e3/k))}()}return c},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=void 0),this},lines:function(d,f){function h(b,c){return e(a(),{position:"absolute",width:f.length+f.width+"px",height:f.width+"px",background:b,boxShadow:c,transformOrigin:"left",transform:"rotate("+~~(360/f.lines*k+f.rotate)+"deg) translate("+f.radius+"px,0)",borderRadius:(f.corners*f.width>>1)+"px"})}for(var i,k=0,l=(f.lines-1)*(1-f.direction)/2;k<f.lines;k++)i=e(a(),{position:"absolute",top:1+~(f.width/2)+"px",transform:f.hwaccel?"translate3d(0,0,0)":"",opacity:f.opacity,animation:j&&c(f.opacity,f.trail,l+k*f.direction,f.lines)+" "+1/f.speed+"s linear infinite"}),f.shadow&&b(i,e(h("#000","0 0 4px #000"),{top:"2px"})),b(d,b(i,h(g(f.color,k),"0 0 1px rgba(0,0,0,.1)")));return d},opacity:function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)}});var o=e(a("group"),{behavior:"url(#default#VML)"});return!d(o,"transform")&&o.adj?i():j=d(o,"animation"),h});var api=function(){var a={lines:7,length:3,width:9,radius:14,corners:1,rotate:38,direction:1,color:"#000",speed:1,trail:50,shadow:!1,hwaccel:!1,className:"spinner",zIndex:2e9,top:"50%",left:"50%"},b=function(b,c,d){var e=document.getElementById("spin"),f=new Spinner(a).spin(e);$.ajax({type:"POST",url:b,data:JSON.stringify(c)||{},contentType:"application/json; charset=UTF-8",dataType:"json",success:function(a){f.stop(),$("#spin").remove(),d(a)},error:function(a,b,c){d({msg:c})}})},c={getCourses:"User/getCourses",addCourse:"Course/add",searchCourse:"Course/search",createCourse:"Course/create",updateCourse:"Course/update",getFormulaCourse:"Course/getFormula",shareCourse:"Course/share",deleteCourse:"Course/del",contactForm:"contact"};return{consume:function(a,d,e){b(c[a],d,e)}}}(),control_panel=function(){var a=$("#controls-label"),b=$("#controls-grade"),c=$("#controls-erase"),d=$("#controls-add"),e=$("#controls-save"),f=null,g=null,h=null,i=null,j={set_tree:function(a){f=a},init:function(a){i=a,j.set_label(a.l),j.set_grade(a.grade),h=function(){f.addLeaf(a.v)},g=function(){f.removeLeaf(a.v)}},set_label:function(b){a.val(b)},set_grade:function(a){b.val(a)},on_erase:function(){g(),j.cur_node=null,j.set_label(""),j.set_grade("")},on_add:function(){h()},on_save:function(){i.l=a.val(),i.grade=b.val(),f.redraw()}};return c.click(j.on_erase),d.click(j.on_add),e.click(j.on_save),j};$(function(){var a=function(){var a=$(window).height();return a-50};$(window).on("load resize",function(){$("#grades-container").height(a())});var b=control_panel();$(window).on("load",function(){var c=tree("#grades-container",a(),function(a){b.init(a)});b.set_tree(c)}),$("#simulate").click(function(){t.simulate()})});var courseSearch=function(a,b,c){var d=a,b=b,c=c,e=$("#course-search"),f=$("#course-search-box"),g=$("#btn-search"),h=$("#search-results"),i=$("#remove-search"),j=$("#no-results"),k=$("#new-course");k.on("click",function(){l.new_course_handler(f.val()),j.hide()}),i.on("click",function(){h.children().remove(),f.val(""),j.hide()}),g.on("click",function(){e.submit()});var l={selected_handler:null,add_handler:null,new_course_handler:null},m=function(a,b){l.selected_handler&&l.selected_handler(a,b)},n=function(a){a.remove()},o=function(a){d.consume("addCourse",{id:a},function(a){return a.msg&&"OK"!=a.msg?console.log("error",a.msg):void l.add_handler(a)})},p=function(a){var b='<li class="course"><a><span class="name">'+a.name+'</span><span class="menu-icon click-menu"><span class="add glyphicon glyphicon-floppy-disk"></span><span class="remove glyphicon glyphicon-remove"></span></a></a></li>';return $(b)};e.on("submit",function(a){a.preventDefault();var e=f.val();return e&&e.length?void d.consume("searchCourse",{name:e},function(a){if(j.hide(),a.msg)return console.log("error",a.msg);h.empty(),a.length||j.show();for(var b=0;b<a.length;b++)q(a[b])}):(console.log("er",e),void b.show_err_submit(f,c.input_required))});var q=function(a){var b=p(a);b.find(".remove").on("click",function(a){n(b),a.stopPropagation()}),b.find(".add").on("click",function(b){o(a._id),b.stopPropagation()}),b.find("a").on("click",function(){m(a,b)}),h.append(b)};return l},course=function(a,b,c){var d=a,b=b,c=c,e=$("#course-list"),f=$("#my-courses");f.on("click",function(){e.toggle("slow")});var g=function(a){var e={name:a,formula:""};d.consume("createCourse",e,function(a){return a.msg?console.log("error",a.msg):(o(a),void b.show_ok_msg(c.course_create_ok))})},h=function(a,b){q.selected_handler&&q.selected_handler(a,b)},i=function(a){d.consume("shareCourse",{id:a},function(a){return"OK"!=a.msg?console.log("error",a.msg):void b.show_ok_msg(c.course_share_ok)})},j=function(a){$("html").on("click.edit",function(){a(),k()})},k=function(){$("html").off("click.edit")},l=function(a,e){var f=e.children().first(),g=$('<span class="clearfix edit-menu"><input type="text" value="'+a.name+'" class="name pull-left"><span class="menu-icon"><span class="ok glyphicon glyphicon-ok"></span><span class="cancel glyphicon glyphicon-remove"></span></span></span>');f.hide();var h=function(){g.remove(),f.show()};j(h),g.on("click",function(a){a.stopPropagation()}),g.find(".ok").on("click",function(e){var i={id:a._id,name:g.find(".name").val()};return i.name&&i.name.length?void d.consume("updateCourse",i,function(a){return"OK"!=a.msg?console.log("error".res.msg):(b.show_ok_msg(c.course_edit_ok),f.find(".name").text(i.name),h(),void e.stopPropagation())}):(b.show_err_submit(g.find(".name"),c.input_required),void e.stopPropagation())}),g.find(".cancel").on("click",function(){h()}),e.append(g)},m=function(a,e){d.consume("deleteCourse",{id:a},function(a){return"OK"!=a.msg?console.log("error".res.msg):(e.remove(),void b.show_ok_msg(c.course_remove_ok))})},n=function(a){var b='<li class="course"><a><span class="name">'+a.name+'</span><span class="menu-icon click-menu"><span class="share glyphicon glyphicon-cloud"></span><span class="edit glyphicon glyphicon-pencil"></span><span class="remove glyphicon glyphicon-remove"></span></a></a></li>';return $(b)},o=function(a){var b=n(a);b.find("a").on("click",function(){h(a,b)}),b.find(".share").on("click",function(b){i(a._id),b.stopPropagation()}),b.find(".edit").on("click",function(c){l(a,b),c.stopPropagation()}),b.find(".remove").on("click",function(c){m(a._id,b),c.stopPropagation()}),e.append(b)},p=function(){d.consume("getCourses",{},function(a){for(var b=a.courses,c=0;c<b.length;c++)o(b[c])})};p();var q={selected_handler:null,add:o,create:g};return q},strings={course_create_ok:"Curso creado.",course_edit_ok:"Información actualizada.",course_remove_ok:"Curso eliminado.",course_share_ok:"Curso compartido.",course_error:"GG feeder",input_required:"Campo obligatorio"},main={init:function(a,b){var c=courseSearch(a,main,b),d=course(a,main,b),e=$("#left-panel"),f=parseInt(e.css("width")),g=$("#toggle-left-panel"),h=function(a){console.log(f);var b=f-parseInt(g.css("left"));e.toggle("slow"),g.animate({left:b+"px"},"slow");var c=$("#grades-container");"2"==c.css("z-index")&&c.animate({left:b+"px"},"slow"),a.stopPropagation()};g.on("click",h);var i=function(a,b){$("#left-panel .active").removeClass("active"),b.addClass("active"),$(".click-menu").hide(),b.find(".click-menu").show(),console.log(a)};d.selected_handler=i,c.add_handler=d.add,c.selected_handler=i,c.new_course_handler=d.create},config:{msg_template:{part1:'<div class="alert ',part2:'" role="alert"><button class="close" data-dismiss="alert"><span aria-hidden="true">&times<span class="sr-only">Close</span></span></button>',part3:"</div>"}},show_ok_msg:function(a){main.show_msg(a,"alert-success")},show_err_msg:function(a){main.show_msg(a,"alert-danger")},show_err_submit:function(a,b){console.log("elem",a),a.tooltip({title:b}),a.tooltip("show")},show_msg:function(a,b){var c=main.config.msg_template,d=$(c.part1+b+c.part2+a+c.part3);$("#messages").append(d),setTimeout(function(){d.fadeOut("slow",function(){d.remove()})},1e3)}};$(function(){$("#home").addClass("active"),main.init(api,strings)});